- name: install packages
  loop:
    - duply
    - python-paramiko
    - python-boto
    - lftp
    - cronic
    - ftp
  package:
    name: '{{ item }}'
    state: present
  tags:
    - duply

- name: create dir
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}'
  file:
    path: /etc/duply/{{ item.name }}
    mode: 0700
    state: '{% if item.state | default("present") == "present" %}directory{% else %}absent{% endif %}'
  tags:
    - duply

- name: write config
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/conf'
  when: item.state | default("present") == "present"
  template:
    src: config.j2
    dest: /etc/duply/{{ item.name }}/conf
    mode: 0600
  tags:
    - duply

- name: drop config
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/conf'
  when: item.state | default("present") == "absent"
  file:
    path: /etc/duply/{{ item.name }}/conf
    state: absent
  tags:
    - duply

- name: write exclude
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/exclude'
  when: item.state | default("present") == "present"
  template:
    src: exclude.j2
    dest: /etc/duply/{{ item.name }}/exclude
    mode: 0600
  tags:
    - duply

- name: drop exclude
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/exclude'
  when: item.state | default("present") == "absent"
  file:
    path: /etc/duply/{{ item.name }}/exclude
    state: absent
  tags:
    - duply

- name: write pre
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/pre'
  when: item.pre | default(False)
  copy:
    content: '{{ item.pre }}'
    dest: /etc/duply/{{ item.name }}/pre
    mode: 0700
  tags:
    - duply

- name: drop pre
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/pre'
  when: item.pre | default('') == ''
  file:
    path: /etc/duply/{{ item.name }}/pre
    state: absent
  tags:
    - duply

- name: write post
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/post'
  when: item.post | default(False)
  copy:
    content: '{{ item.post }}'
    dest: /etc/duply/{{ item.name }}/post
    mode: 0700
  tags:
    - duply

- name: drop post
  loop: '{{ duply_profiles }}'
  loop_control:
    label: '/etc/duply/{{ item.name }}/post'
  when: item.post | default('') == ''
  file:
    path: /etc/duply/{{ item.name }}/post
    state: absent
  tags:
    - duply

- name: write cronjob
  loop: '{{ duply_profiles }}'
  loop_control:
    label: 'name: backup {{ item.name }}, job: {{ item.minute | default(duply_default_minute) }} {{ item.hour | default(duply_default_hour) }} {{ item.day | default(duply_default_day) }} {{ item.month | default(duply_default_month) }} {{ item.weekday | default(duply_default_weekday) }} cronic duply {{ item.name }} {{ item.command | default(duply_default_command) }}'
  cron:
    name: backup {{ item.name }}
    minute: '{{ item.minute | default(duply_default_minute) }}'
    hour: '{{ item.hour | default(duply_default_hour) }}'
    day: '{{ item.day | default(duply_default_day) }}'
    month: '{{ item.month | default(duply_default_month) }}'
    weekday: '{{ item.weekday | default(duply_default_weekday) }}'
    job: cronic duply {{ item.name }} {{ item.command | default(duply_default_command) }}
    state: '{{ item.state | default("present") }}'
  tags:
    - duply
